<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clock Drawing Test ‚Äì Quizzard Style</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    :root {
      --brand: #0d6efd;
      /* Bootstrap primary */
      --brand-2: #ff6b6b;
      /* bright supporting */
      --brand-3: #ffd166;
      /* bright supporting */
      --ink: #111;
    }

    body {
      background: linear-gradient(135deg, #f0f6ff 0%, #fff 55%, #fff7f7 100%);
    }

    .quizzard-card.card {
      border: 0;
      border-radius: 1.25rem;
      box-shadow: 0 12px 40px rgba(13, 110, 253, .18);
      overflow: hidden;
    }

    .quizzard-card .card-header {
      background: linear-gradient(90deg, var(--brand) 0%, #7aa6ff 50%, var(--brand) 100%);
      color: #fff;
      padding: 1.25rem 1.5rem;
    }

    .title-badge {
      background: #fff;
      color: var(--brand);
      font-weight: 800;
      border-radius: 999px;
      padding: .35rem .9rem;
      box-shadow: 0 6px 16px rgba(0, 0, 0, .08);
    }

    .instructions {
      border-left: .5rem solid var(--brand);
      background: #f8fbff;
    }

    .tool-btn {
      font-weight: 800;
      letter-spacing: .3px;
      padding: .85rem 1rem !important;
    }

    .tool-btn.active {
      outline: 3px solid var(--brand);
      outline-offset: 2px;
      background-color: #e7f1ff !important;
    }

    .size-output {
      min-width: 3ch;
      display: inline-block;
      font-weight: 800;
    }

    /* Canvas container keeps aspect and makes canvas responsive */
    .canvas-wrap {
      position: relative;
      width: 100%;
      background: #fff;
      border-radius: 1rem;
      border: 2px dashed rgba(13, 110, 253, .3);
    }

    canvas#board {
      display: block;
      width: 100%;
      height: auto;
      touch-action: none;
      /* avoid scrolling while drawing */
      border-radius: 1rem;
      background:
        radial-gradient(circle at 20% 15%, rgba(13, 110, 253, .06), transparent 35%),
        radial-gradient(circle at 80% 0%, rgba(255, 107, 107, .06), transparent 40%),
        #fff;
    }

    .sr-only-vis {
      position: absolute;
      left: -9999px;
      width: 1px;
      height: 1px;
      overflow: hidden;
    }
  </style>
</head>

<body>
  <div class="container py-4 py-md-5">
    <div class="row justify-content-center">
      <div class="col-12 col-lg-10 col-xl-9">
        <div class="card quizzard-card">
          <div class="card-header d-flex flex-wrap align-items-center gap-3">
            <span class="title-badge">Clock Drawing Test</span>
            <div class="ms-auto d-flex align-items-center gap-2">
              <span class="badge text-bg-light text-dark fw-bold">Target time: <span id="targetTime">10 minutes after
                  11</span></span>
            </div>
          </div>
          <div class="card-body p-3 p-md-4 p-lg-5">

            <!-- Instructions -->
            <div class="instructions p-3 p-md-4 rounded-3 mb-4">
              <p class="h4 fw-bold text-primary mb-3">Follow the instructions below to draw a clock.</p>
              <ol class="fs-5 fw-bold text-dark m-0" style="line-height:1.6">
                <li>Step 1. Draw a full circle</li>
                <li>Step 2. Place numbers on the circle like a clock</li>
                <li>Step 3. Place hands on the clock showing the time to be <span class="text-danger">10 minutes after
                    11</span></li>
              </ol>
            </div>

            <!-- Toolbar -->
            <div class="d-flex flex-wrap align-items-center gap-2 gap-md-3 mb-3">
              <button id="penBtn" class="btn btn-primary tool-btn" type="button" aria-pressed="true">‚úèÔ∏è Pen</button>
              <button id="eraserBtn" class="btn btn-warning tool-btn" type="button">üßΩ Eraser</button>

              <div class="vr d-none d-md-block"></div>

              <label class="fw-bold">Color
                <input id="color" type="color" class="form-control form-control-color ms-2" value="#111111"
                  title="Choose stroke color" />
              </label>

              <div class="d-flex align-items-center gap-2">
                <label for="size" class="fw-bold mb-0">Size</label>
                <input id="size" type="range" min="2" max="40" step="1" value="6" class="form-range"
                  style="width:180px" />
                <span class="size-output" id="sizeOut">6</span>
              </div>

              <div class="ms-auto d-flex flex-wrap gap-2">
                <button id="undoBtn" class="btn btn-outline-secondary tool-btn" type="button">‚Ü∂ Undo</button>
                <button id="clearBtn" class="btn btn-danger tool-btn" type="button">üóëÔ∏è Clear</button>
                <button id="submitBtn" class="btn btn-success tool-btn" type="button">‚úÖ Submit</button>
              </div>
            </div>

            <!-- Canvas -->
            <div class="canvas-wrap p-2 p-md-3">
              <canvas id="board" width="900" height="600" aria-label="Drawing canvas for clock test"
                role="img"></canvas>
            </div>

            <p class="text-muted mt-3 mb-0 fw-semibold">Tip: Use two fingers to scroll the page while not drawing. The
              canvas captures single‚Äëfinger drags to draw.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Canvas state & helpers ---
    const canvas = document.getElementById('board');
    const ctx = canvas.getContext('2d');

    // Hi‚ÄëDPI crispness
    function fitHiDPI() {
      const ratio = window.devicePixelRatio || 1;
      const css = canvas.getBoundingClientRect();
      canvas.width = Math.round(css.width * ratio);
      canvas.height = Math.round(css.height * ratio);
      ctx.scale(ratio, ratio);
      // Redraw background grid watermark if desired
      redrawFromHistory();
    }

    // History for undo
    const history = [];
    function pushHistory() {
      history.push(canvas.toDataURL());
      if (history.length > 50) history.shift();
    }

    function redrawFromHistory() {
      if (history.length === 0) return;
      const img = new Image();
      img.onload = () => {
        const css = canvas.getBoundingClientRect();
        ctx.clearRect(0, 0, css.width, css.height);
        ctx.drawImage(img, 0, 0, css.width, css.height);
      };
      img.src = history[history.length - 1];
    }

    // Initial style
    let drawing = false;
    let tool = 'pen';
    let strokeColor = document.getElementById('color').value;
    let strokeSize = parseInt(document.getElementById('size').value, 10);

    const penBtn = document.getElementById('penBtn');
    const eraserBtn = document.getElementById('eraserBtn');
    const sizeRange = document.getElementById('size');
    const sizeOut = document.getElementById('sizeOut');

    function setActive(btn) {
      [penBtn, eraserBtn].forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    }

    penBtn.addEventListener('click', () => { tool = 'pen'; setActive(penBtn); });
    eraserBtn.addEventListener('click', () => { tool = 'eraser'; setActive(eraserBtn); });

    document.getElementById('color').addEventListener('input', (e) => {
      strokeColor = e.target.value;
    });

    sizeRange.addEventListener('input', (e) => {
      strokeSize = parseInt(e.target.value, 10);
      sizeOut.textContent = String(strokeSize);
    });

    // Coordinate translation from CSS pixels to canvas drawing pixels
    function getPoint(evt) {
      const rect = canvas.getBoundingClientRect();
      const x = (evt.clientX ?? (evt.touches && evt.touches[0]?.clientX)) - rect.left;
      const y = (evt.clientY ?? (evt.touches && evt.touches[0]?.clientY)) - rect.top;
      return { x, y };
    }

    let last = null;

    function beginDraw(p) {
      drawing = true; last = p; pushHistory();
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.strokeStyle = tool === 'pen' ? strokeColor : '#ffffff';
      ctx.lineWidth = strokeSize;
    }

    function drawTo(p) {
      if (!drawing || !last) return;
      ctx.beginPath();
      ctx.moveTo(last.x, last.y);
      ctx.lineTo(p.x, p.y);
      ctx.strokeStyle = tool === 'pen' ? strokeColor : '#ffffff';
      ctx.lineWidth = strokeSize;
      ctx.stroke();
      last = p;
    }

    function endDraw() { drawing = false; last = null; }

    // Mouse
    canvas.addEventListener('mousedown', (e) => beginDraw(getPoint(e)));
    canvas.addEventListener('mousemove', (e) => drawTo(getPoint(e)));
    window.addEventListener('mouseup', endDraw);

    // Touch
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); beginDraw(getPoint(e)); });
    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); drawTo(getPoint(e)); });
    canvas.addEventListener('touchend', (e) => { e.preventDefault(); endDraw(); });

    // Clear & Undo & Submit
    document.getElementById('clearBtn').addEventListener('click', () => {
      pushHistory();
      const css = canvas.getBoundingClientRect();
      ctx.clearRect(0, 0, css.width, css.height);
    });

    document.getElementById('undoBtn').addEventListener('click', () => {
      if (history.length <= 1) return; // keep at least one state
      history.pop();
      const img = new Image();
      img.onload = () => {
        const css = canvas.getBoundingClientRect();
        ctx.clearRect(0, 0, css.width, css.height);
        ctx.drawImage(img, 0, 0, css.width, css.height);
      };
      img.src = history[history.length - 1];
    });

    document.getElementById('submitBtn').addEventListener('click', () => {
      // Simulate processing time
      const btn = document.getElementById('submitBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '‚è≥ Analyzing...';
      btn.disabled = true;

      setTimeout(() => {
        // Mock scoring logic (randomized for demo)
        const contour = 3;
        const numbers = Math.floor(Math.random() * (11 - 9) + 9); // 9-11
        const hands = Math.floor(Math.random() * (6 - 4) + 4);    // 4-6
        const total = contour + numbers + hands;

        let analysis = "Contour is well-formed. ";
        if (numbers < 11) analysis += "Spacing of numbers shows minor irregularity. ";
        if (hands < 6) analysis += "Hand placement is slightly off-target for 11:10. ";

        // Capture Canvas Image
        const dataURL = canvas.toDataURL('image/png');

        const result = {
          timestamp: new Date().toISOString(),
          scores: {
            contour: contour,
            numbers: numbers,
            hands: hands,
            total: total
          },
          analysis: analysis,
          image: dataURL
        };

        // Save to Session Storage
        sessionStorage.setItem('cdt_data', JSON.stringify(result));

        // Show Feedback
        btn.innerHTML = '‚úÖ Analysis Complete';
        alert(`Analysis Complete! Redirecting to next test...`);

        // Redirect to MCFT
        window.location.href = 'mcft.html';

      }, 1500);
    });

    // Initialize active state and baseline history
    setActive(penBtn);
    (function init() {
      // Create an initial blank state for Undo baseline and draw a faint target text
      const css = canvas.getBoundingClientRect();
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, css.width, css.height);
      ctx.fillStyle = 'rgba(13,110,253,.6)';
      ctx.font = '700 22px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText('Draw a clock showing 10 minutes after 11', 16, 36);
      pushHistory();
    })();

    // Re‚Äëfit canvas pixels when resized
    new ResizeObserver(() => fitHiDPI()).observe(canvas);
    fitHiDPI();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>